{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>USA Property Price Visualization</title>
    <!-- 引入D3.js及相关库 -->
    <script type="text/javascript" src="{% static 'lib/d3.v5.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'lib/d3-legend.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'lib/d3-tip.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <!-- 导航栏 -->
    <nav>
        <a href="{% url 'visualization' %}">Visualization</a> |
        <a href="{% url 'price_query' %}">Prediction</a> |
        <a href="{% url 'choropleth' %}">Choropleth Map</a>
    </nav>

    <!-- 标题 -->
    <h1 class="title">USA Property Price Visualization</h1>

    <!-- Choropleth地图容器 -->
    <div id="choroplethContainer">
        <!-- 选项选择器 -->
        <div id="optionSelector">
            <label>
                <input type="radio" name="metric" value="price_median" checked>
                Median Price by State
            </label>
            <label>
                <input type="radio" name="metric" value="total_listings">
                Number of Listings by State
            </label>
        </div>
        <!-- Choropleth地图的SVG将由D3.js添加在这里 -->
    </div>

    <!-- Choropleth地图的工具提示 -->
    <div id="choroplethTooltip" class="d3-tip" style="visibility: hidden;"></div>

    <!-- 蜘蛛图容器 -->
    <div id="plotDiv"></div>
    <div id="multiDimensionalPlot"></div>

    <!-- D3.js脚本 -->
    <script type="text/javascript">
        (function () {
            // 配置参数
            const margin = { top: 20, right: 20, bottom: 20, left: 20 };
            const width = 960 - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom;

            // 创建Choropleth地图的SVG
            const svgChoropleth = d3.select("#choroplethContainer").append("svg")
                .attr("id", "choropleth")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // 工具提示
            const tooltipChoropleth = d3.select("#choroplethTooltip");

            // 颜色比例尺函数
            const createColorScale = (metrics) =>
                d3.scaleQuantile()
                    .domain(metrics)
                    .range(["#f2f0f7", "#cbc9e2", "#9e9ac8", "#756bb1", "#54278f"]); // 5类Purples

            // 定义投影和路径生成器
            const projection = d3.geoAlbersUsa()
                .scale(1000)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            // 状态缩写映射
            const stateAbbreviations = {
                "Alabama": "AL",
                "Alaska": "AK",
                "Arizona": "AZ",
                "Arkansas": "AR",
                "California": "CA",
                "Colorado": "CO",
                "Connecticut": "CT",
                "Delaware": "DE",
                "Florida": "FL",
                "Georgia": "GA",
                "Hawaii": "HI",
                "Idaho": "ID",
                "Illinois": "IL",
                "Indiana": "IN",
                "Iowa": "IA",
                "Kansas": "KS",
                "Kentucky": "KY",
                "Louisiana": "LA",
                "Maine": "ME",
                "Maryland": "MD",
                "Massachusetts": "MA",
                "Michigan": "MI",
                "Minnesota": "MN",
                "Mississippi": "MS",
                "Missouri": "MO",
                "Montana": "MT",
                "Nebraska": "NE",
                "Nevada": "NV",
                "New Hampshire": "NH",
                "New Jersey": "NJ",
                "New Mexico": "NM",
                "New York": "NY",
                "North Carolina": "NC",
                "North Dakota": "ND",
                "Ohio": "OH",
                "Oklahoma": "OK",
                "Oregon": "OR",
                "Pennsylvania": "PA",
                "Rhode Island": "RI",
                "South Carolina": "SC",
                "South Dakota": "SD",
                "Tennessee": "TN",
                "Texas": "TX",
                "Utah": "UT",
                "Vermont": "VT",
                "Virginia": "VA",
                "Washington": "WA",
                "West Virginia": "WV",
                "Wisconsin": "WI",
                "Wyoming": "WY"
            };

            // 状态特定GeoJSON缓存
            const stateGeoJSONCache = new Map();

            let stateData; // 存储状态聚合数据的全局变量

            // 加载初始数据
            Promise.all([
                d3.json("{% static 'geojson/us_states.json' %}"),
                d3.csv("{% static 'data/aggregated_by_state.csv' %}", function (d) {
                    return {
                        state: d["state"],
                        total_listings: +d["total_listings"],
                        price_median: +d["price_median"],
                        bed_median: +d["bed_median"],
                        bath_median: +d["bath_median"],
                        acre_lot_median: +d["acre_lot_median"],
                        house_size_median: +d["house_size_median"]
                    };
                })
            ]).then(([statesGeoJSON, stateDataLoaded]) => {
                stateData = stateDataLoaded; // 赋值给全局变量
                console.log("States GeoJSON Data:", statesGeoJSON);
                console.log("State Aggregated Data:", stateData);

                // 初始指标
                let currentMetric = 'price_median';

                // 渲染初始地图
                renderMap(statesGeoJSON, currentMetric);

                // 预加载状态特定的GeoJSON文件以提升性能
                prefetchStateGeoJSON();

                // 初始化事件监听器
                initializeEventListeners(statesGeoJSON);

                // 初始化多维度绘图容器
                initializeMultiDimensionalPlot();
            }).catch(error => {
                console.error("Error loading or parsing data.", error);
            });

            // 渲染Choropleth地图的函数
            function renderMap(statesGeoJSON, metric) {
                // 清除现有地图和图例
                svgChoropleth.selectAll("*").remove();

                // 创建基于选定指标的颜色比例尺
                const colorScale = createColorScale(stateData.map(d => d[metric]));
                console.log("Color Scale Domain:", stateData.map(d => d[metric]));

                // 绘制各州
                svgChoropleth.selectAll("path")
                    .data(statesGeoJSON.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1)
                    .attr("fill", d => {
                        const stateInfo = stateData.find(s => s.state === d.properties.name);
                        return stateInfo ? colorScale(stateInfo[metric]) : "#ccc";
                    })
                    .on("mouseover", function (event, d) {
                        const stateInfo = stateData.find(s => s.state === d.properties.name);
                        if (stateInfo) {
                            tooltipChoropleth.style("visibility", "visible")
                                .html(`
                                    <strong>State:</strong> ${stateInfo.state}<br>
                                    <strong>${metric === 'price_median' ? 'Median Price' : 'Total Listings'}:</strong> ${metric === 'price_median' ? '$' + stateInfo[metric].toLocaleString() : stateInfo[metric]}
                                `);
                        }
                        d3.select(this).attr("stroke", "yellow").attr("stroke-width", 2);
                    })
                    .on("mousemove", function (event) {
                        tooltipChoropleth
                            .style("top", (event.pageY - 10) + "px")
                            .style("left", (event.pageX + 10) + "px");
                    })
                    .on("mouseout", function () {
                        tooltipChoropleth.style("visibility", "hidden");
                        d3.select(this).attr("stroke", "#fff").attr("stroke-width", 1);
                    })
                    // 添加拖拽行为
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                // 添加图例
                const legend = svgChoropleth.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", "translate(20,20)");

                const legendColor = d3.legendColor()
                    .scale(colorScale)
                    .shapeWidth(30)
                    .orient('horizontal')
                    .cells(colorScale.quantiles())
                    .labelFormat(d3.format(metric === "price_median" ? "$,.2s" : ",.0f"))
                    .title(metric === "price_median" ? "Median Price by State" : "Number of Listings by State");

                svgChoropleth.select(".legendQuant")
                    .call(legendColor);
            }

            // 初始化事件监听器的函数
            function initializeEventListeners(statesGeoJSON) {
                // 单选按钮更改事件
                d3.selectAll("input[name='metric']").on("change", function () {
                    const selectedOption = d3.select("input[name='metric']:checked").property("value");
                    console.log("Selected Metric:", selectedOption);
                    updateMap(statesGeoJSON, selectedOption);
                });
            }

            // 更新地图的函数
            function updateMap(statesGeoJSON, selectedOption) {
                renderMap(statesGeoJSON, selectedOption);
            }

            // 拖拽事件函数
            function dragstarted(event, d) {
                d3.select(this).raise().attr("stroke", "black");
                this._initialX = event.x;
                this._initialY = event.y;
                this._initialTransform = d3.select(this).attr("transform") || null;
            }

            function dragged(event, d) {
                const dx = event.x - this._initialX;
                const dy = event.y - this._initialY;
                d3.select(this).attr("transform", `translate(${dx}, ${dy})`);
            }

            function dragended(event, d) {
                // 重置变换
                d3.select(this).attr("transform", this._initialTransform);
                d3.select(this).attr("stroke", "#fff");

                const finalPosition = [event.x, event.y];
                console.log("Final Position:", finalPosition);

                // 定义一个阈值区域，若拖拽到该区域则触发详细视图
                if (finalPosition[0] > width * 0.6) {
                    const stateName = d.properties.name;
                    console.log("State dragged to trigger details:", stateName);
                    fetchStateDetails(stateName);
                }
            }

            // 获取状态特定GeoJSON和数据的函数
            function fetchStateDetails(stateName) {
                // 移除现有的状态特定地图和绘图
                d3.select("#stateMap").remove();
                d3.select("#multiDimensionalPlot").remove();

                const stateAbbrev = stateAbbreviations[stateName];
                if (!stateAbbrev) {
                    console.error(`No abbreviation found for state: ${stateName}`);
                    return;
                }

                const formattedStateName = stateName.replace(/\s+/g, '_');

                // 正确的路径构建：
                // 使用静态路径的基础部分，并在JavaScript中拼接变量部分
                const geojsonBasePath = "{% static 'geojson/' %}";
                const csvBasePath = "{% static 'data/aggregated_by_zipcode/' %}";

                const geojsonPath = geojsonBasePath + stateAbbrev + "_" + formattedStateName + "_zip_codes_geo.min.json";
                const csvPath = csvBasePath + stateName + "_zipcodes.csv";

                console.log("Fetching GeoJSON Path:", geojsonPath);
                console.log("Fetching CSV Path:", csvPath);

                Promise.all([
                    stateGeoJSONCache.get(stateName) ||
                        d3.json(geojsonPath).then(data => {
                            stateGeoJSONCache.set(stateName, data);
                            return data;
                        }),
                    d3.csv(csvPath, function (d) {
                        return {
                            zipcode: d["zipcode"] || d["zip_code"] || d["Zipcode"] || d["ZIP"],
                            total_listings: +d["total_listings"],
                            price_median: +d["price_median"],
                            bed_median: +d["bed_median"],
                            bath_median: +d["bath_median"],
                            acre_lot_median: +d["acre_lot_median"],
                            house_size_median: +d["house_size_median"]
                        };
                    })
                ]).then(([geoData, zipcodeData]) => {
                    // 清理并合并数据
                    zipcodeData = zipcodeData.filter(d => d.zipcode !== null);
                    geoData.features.forEach(feature => {
                        const zipcode = String(feature.properties.ZCTA5CE10).padStart(5, '0');
                        const zipcodeInfo = zipcodeData.find(d => d.zipcode === zipcode);
                        if (zipcodeInfo) {
                            feature.properties = { ...feature.properties, ...zipcodeInfo };
                        }
                    });

                    // 渲染状态特定地图
                    renderStateMap(geoData, stateName, zipcodeData);

                    // 生成多维度绘图
                    generateMultiDimensionalPlot(zipcodeData);
                }).catch(error => {
                    console.error("Error loading state-specific data:", error);
                    alert(`Failed to load data for ${stateName}. Please try again.`);
                });
            }

            // 渲染状态特定地图的函数
            function renderStateMap(stateGeoJSON, stateName, zipcodeData) {
                const svg = d3.select("body").append("svg")
                    .attr("id", "stateMap")
                    .attr("width", 300)
                    .attr("height", 300)
                    .style("position", "absolute")
                    .style("top", "100px")
                    .style("right", "50px")
                    .style("background", "rgba(255, 255, 255, 0.9)")
                    .style("border", "1px solid #ccc")
                    .style("padding", "10px")
                    .style("box-shadow", "0px 0px 10px rgba(0,0,0,0.5)");

                const projection = d3.geoMercator()
                    .fitSize([280, 280], stateGeoJSON);
                const path = d3.geoPath().projection(projection);

                // 定义ZIP代码的颜色比例尺
                const zipPrices = stateGeoJSON.features
                    .map(d => d.properties.price_median)
                    .filter(d => d);
                const colorScale = createColorScale(zipPrices);
                console.log("ZIP Code Color Scale Domain:", zipPrices);

                // ZIP代码的工具提示
                const zipTooltip = d3.select("body").append("div")
                    .attr("class", "d3-tip")
                    .style("visibility", "hidden")
                    .style("position", "absolute")
                    .style("background", "rgba(236, 155, 4, 0.75)")
                    .style("color", "#fff")
                    .style("padding", "8px")
                    .style("border-radius", "5px")
                    .style("font-size", "14px");

                // 绘制ZIP代码区域
                svg.selectAll("path")
                    .data(stateGeoJSON.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.5)
                    .attr("fill", d => {
                        const price = d.properties.price_median;
                        return price ? colorScale(price) : "#888";
                    })
                    .on("mouseover", function (event, d) {
                        zipTooltip.style("visibility", "visible")
                            .html(`
                                <strong>ZIP Code:</strong> ${d.properties.ZCTA5CE10}<br>
                                <strong>Median Price:</strong> ${d.properties.price_median ? '$' + d.properties.price_median.toLocaleString() : 'N/A'}<br>
                                <strong>Total Listings:</strong> ${d.properties.total_listings || 'N/A'}
                            `);
                        d3.select(this).attr("stroke", "yellow").attr("stroke-width", 1.5);
                    })
                    .on("mousemove", function (event) {
                        zipTooltip
                            .style("top", (event.pageY - 10) + "px")
                            .style("left", (event.pageX + 10) + "px");
                    })
                    .on("mouseout", function () {
                        zipTooltip.style("visibility", "hidden");
                        d3.select(this).attr("stroke", "#333").attr("stroke-width", 0.5);
                    });

                // 添加ZIP代码图例
                const legend = svg.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", "translate(10,10)");

                const legendColor = d3.legendColor()
                    .scale(colorScale)
                    .shapeWidth(20)
                    .orient('horizontal')
                    .cells(colorScale.quantiles())
                    .labelFormat(d3.format("$.2s"))
                    .title("Median Price by ZIP Code");

                svg.select(".legendQuant")
                    .call(legendColor);
            }

            // 预加载所有状态特定GeoJSON的函数
            function prefetchStateGeoJSON() {
                Object.entries(stateAbbreviations).forEach(([stateName, stateAbbrev]) => {
                    const formattedStateName = stateName.replace(/\s+/g, '_');

                    // 正确的路径构建：
                    // 使用静态路径的基础部分，并在JavaScript中拼接变量部分
                    const geojsonBasePath = "{% static 'geojson/' %}";
                    const geojsonPath = geojsonBasePath + stateAbbrev + "_" + formattedStateName + "_zip_codes_geo.min.json";

                    console.log("Prefetching GeoJSON Path:", geojsonPath);

                    d3.json(geojsonPath)
                        .then(data => {
                            stateGeoJSONCache.set(stateName, data);
                            console.log(`Prefetched GeoJSON for ${stateName}`);
                        })
                        .catch(error => {
                            console.error(`Error prefetching GeoJSON for ${stateName}:`, error);
                        });
                });
            }

            // 初始化多维度绘图容器的函数
            function initializeMultiDimensionalPlot() {
                // 初始隐藏，只有在拖拽州时才显示
                d3.select("#multiDimensionalPlot").style("display", "none");
            }

            // 生成多维度绘图的函数
            function generateMultiDimensionalPlot(zipcodeData) {
                d3.select("#multiDimensionalPlot").style("display", "block").selectAll("*").remove();

                const margin = { top: 20, right: 50, bottom: 30, left: 50 };
                const plotWidth = 900 - margin.left - margin.right;
                const plotHeight = 500 - margin.top - margin.bottom;

                const plotSvg = d3.select("#multiDimensionalPlot").append("svg")
                    .attr("width", plotWidth + margin.left + margin.right)
                    .attr("height", plotHeight + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                plotSvg.append("text")
                    .attr("x", plotWidth / 2)
                    .attr("y", -10)
                    .attr("text-anchor", "middle")
                    .style("font-size", "24px")
                    .style("font-weight", "bold")
                    .style("fill", "#54278f")
                    .text("Multi-Dimensional View");

                const allDimensions = ["Median Price", "Median Bedrooms", "Median Bathrooms", "Median Acre Lot", "Median House Size"];

                const plotData = zipcodeData.map(d => ({
                    zipcode: d.zipcode,
                    "Median Price": d.price_median,
                    "Median Bedrooms": d.bed_median,
                    "Median Bathrooms": d.bath_median,
                    "Median Acre Lot": d.acre_lot_median,
                    "Median House Size": d.house_size_median
                }));

                const medianPrices = plotData.map(d => d["Median Price"]);
                const colorScale = d3.scaleQuantile()
                    .domain(medianPrices)
                    .range(["#cbc9e2", "#9e9ac8", "#756bb1", "#54278f"]);

                const x = d3.scalePoint()
                    .domain(allDimensions)
                    .range([0, plotWidth]);

                const yScales = {};
                allDimensions.forEach(dimension => {
                    yScales[dimension] = d3.scaleLinear()
                        .domain([0, d3.max(plotData, data => data[dimension]) * 1.1])
                        .range([plotHeight, 0]);
                });

                // 绘制每个ZIP代码的线条
                plotData.forEach((data, index) => {
                    plotSvg.append("path")
                        .datum(allDimensions.map(dimension => ({ dimension, value: data[dimension] })))
                        .attr("fill", "none")
                        .attr("stroke", colorScale(data["Median Price"]))
                        .attr("stroke-width", 2)
                        .attr("opacity", 0.35)
                        .attr("zipcode", data.zipcode)
                        .attr("d", d3.line()
                            .x(d => x(d.dimension))
                            .y(d => yScales[d.dimension](d.value))
                        );
                });

                // 绘制坐标轴
                allDimensions.forEach(dimension => {
                    plotSvg.append("g")
                        .attr("transform", `translate(${x(dimension)},0)`)
                        .call(d3.axisLeft(yScales[dimension]));

                    plotSvg.append("text")
                        .attr("x", x(dimension))
                        .attr("y", plotHeight + margin.bottom)
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .style("font-weight", "bold")
                        .style("font-size", "14px")
                        .style("fill", "black")
                        .text(dimension);
                });
            }

        })();
    </script>
</body>

</html>
